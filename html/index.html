<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GLEAPHE - LECTEUR</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Momo+Trust+Display&family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a1a;
            --surface-color: #252525;
            --primary-color: #d4af37; /* Or */
            --secondary-color: #f0f0f0; /* Blanc cass√© */
            --accent-color: #c0392b; /* Rouge vinyle */
            --text-color: #e0e0e0;
            --text-dim: #a0a0a0;
            --border-color: #333;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Rubik', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://www.transparenttextures.com/patterns/concrete-wall.png');
            opacity: 0.05;
            z-index: 0;
        }

        .main-container {
            display: flex;
            gap: 25px;
            width: 95%;
            max-width: 1200px;
            height: 90vh;
            z-index: 2;
        }

        .player-panel, .playlist-panel {
            background: var(--surface-color);
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            padding: 30px;
            display: flex;
            flex-direction: column;
        }

        .player-panel { flex: 1; min-width: 400px; justify-content: space-between; }
        .playlist-panel { flex: 1.5; }

        .player-header h1 {
            font-family: 'Momo Trust Display', sans-serif;
            color: var(--primary-color);
            font-size: 2.5em;
            margin: 0;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .visualizer-container {
            height: 80px;
            margin: 20px 0;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 3px;
            padding: 10px;
            background: #1a1a1a;
            border-radius: 5px;
        }
        .bar {
            width: 6px;
            background: linear-gradient(to top, var(--primary-color), var(--accent-color));
            border-radius: 2px;
            transition: height 0.05s ease-out;
            height: 2px;
        }

        .track-info {
            text-align: center;
            margin: 20px 0;
        }
        .track-title {
            font-size: 1.2em;
            color: var(--secondary-color);
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .track-counter {
            color: var(--text-dim);
            font-size: 0.9em;
            margin-top: 5px;
        }

        .progress-container {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            margin: 15px 0;
            position: relative;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            border-radius: 4px;
            transition: width 0.1s linear;
        }
        .progress-bar::after {
            content: '';
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: var(--secondary-color);
            border-radius: 50%;
            border: 2px solid var(--primary-color);
        }

        .time-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: var(--text-dim);
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
        }
        .control-btn {
            background: #333;
            border: none;
            color: var(--secondary-color);
            width: 50px;
            height: 50px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .control-btn:hover {
            background: var(--primary-color);
            color: var(--bg-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.4);
        }
        .control-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .control-btn.play-pause {
            width: 65px;
            height: 65px;
            font-size: 1.5em;
            background: var(--accent-color);
        }
        .control-btn.play-pause:hover {
            background: #e74c3c;
        }
        .control-btn.active {
            background: var(--primary-color);
            color: var(--bg-color);
        }

        .volume-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .volume-slider {
            width: 120px;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--border-color);
            outline: none;
            border-radius: 3px;
        }
        .volume-slider::-webkit-slider-thumb, .volume-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: var(--primary-color);
            cursor: pointer;
            border-radius: 50%;
        }

        .playlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }
        .playlist-header h2 {
            margin: 0;
            color: var(--primary-color);
            font-weight: 700;
            letter-spacing: 1px;
        }
        .search-bar {
            width: 100%;
            padding: 12px;
            background: #1a1a1a;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 5px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        .search-bar:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .playlist-container {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 10px;
        }
        .playlist-container::-webkit-scrollbar { width: 8px; }
        .playlist-container::-webkit-scrollbar-track { background: var(--bg-color); border-radius: 4px; }
        .playlist-container::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 4px; }
        
        .playlist { list-style: none; padding: 0; margin: 0; }
        .playlist li {
            display: flex;
            align-items: center;
            padding: 12px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.2s ease;
            font-size: 0.9em;
            border-bottom: 1px solid var(--border-color);
        }
        .playlist li:nth-child(even) { background-color: rgba(255,255,255,0.02); }
        .playlist li:hover {
            background-color: rgba(212, 175, 55, 0.1);
        }
        .playlist li.active {
            background-color: rgba(212, 175, 55, 0.2);
            color: var(--primary-color);
            font-weight: 500;
        }
        .playlist li .track-name {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .playlist li .download-btn {
            color: var(--text-dim);
            margin-left: 10px;
            text-decoration: none;
            font-size: 1.2em;
            transition: color 0.2s;
        }
        .playlist li .download-btn:hover {
            color: var(--primary-color);
        }

        /* --- STYLE RESPONSIVE POUR MOBILE --- */
        @media (max-width: 768px) {
            .main-container { flex-direction: column; height: auto; min-height: 100vh; padding: 10px; gap: 15px; }
            .player-panel, .playlist-panel { width: 100%; max-width: none; padding: 20px; }
            .player-panel { min-width: auto; margin-bottom: 0; }
            .player-header h1 { font-size: 2em; }
            .visualizer-container { height: 60px; margin: 15px 0; }
            .track-title { font-size: 1.1em; }
            .controls { gap: 12px; margin: 15px 0; }
            .control-btn { width: 55px; height: 55px; font-size: 1.3em; }
            .control-btn.play-pause { width: 70px; height: 70px; font-size: 1.6em; }
            .playlist-panel { flex-grow: 1; min-height: 300px; }
        }
    </style>
</head>
<body>

    <div class="main-container">
        <section class="player-panel">
            <header class="player-header">
                <h1>GLEAPHE   LECTEUR</h1>
            </header>

            <div class="visualizer-container" id="visualizer"></div>

            <div class="track-info">
                <div class="track-title" id="trackTitle">Chargement de la playlist...</div>
                <div class="track-counter" id="trackCounter">0 / 0</div>
            </div>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="time-info">
                <span id="currentTime">0:00</span>
                <span id="duration">0:00</span>
            </div>

            <div class="controls">
                <button class="control-btn" id="prevBtn" title="Pr√©c√©dent">‚èÆ</button>
                <button class="control-btn play-pause" id="playPauseBtn" title="Lecture/Pause">‚ñ∂</button>
                <button class="control-btn" id="nextBtn" title="Suivant">‚è≠</button>
                <button class="control-btn" id="shuffleBtn" title="Al√©atoire">üîÄ</button>
                <button class="control-btn" id="repeatBtn" title="R√©p√©ter">üîÅ</button>
            </div>

            <div class="volume-control">
                <span>üîä</span>
                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.01" value="0.7">
            </div>
        </section>

        <section class="playlist-panel">
            <div class="playlist-header">
                <h2>PLAYLIST</h2>
            </div>
            <input type="text" class="search-bar" id="searchBar" placeholder="Rechercher une piste...">
            <div class="playlist-container">
                <ul class="playlist" id="playlist"></ul>
            </div>
        </section>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- √âL√âMENTS DU DOM ---
            const audio = new Audio();
            const playPauseBtn = document.getElementById('playPauseBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const shuffleBtn = document.getElementById('shuffleBtn');
            const repeatBtn = document.getElementById('repeatBtn');
            const progressBar = document.getElementById('progressBar');
            const progressContainer = document.getElementById('progressContainer');
            const currentTimeEl = document.getElementById('currentTime');
            const durationEl = document.getElementById('duration');
            const volumeSlider = document.getElementById('volumeSlider');
            const trackTitleEl = document.getElementById('trackTitle');
            const playlistEl = document.getElementById('playlist');
            const searchBar = document.getElementById('searchBar');
            const trackCounterEl = document.getElementById('trackCounter');
            const visualizerEl = document.getElementById('visualizer');

            // --- √âTAT DU LECTEUR ---
            let tracks = [];
            let filteredTracks = [];
            let currentTrackIndex = 0;
            let isPlaying = false;
            let isShuffled = false;
            let repeatMode = 'off';

            // --- FONCTION POUR CHARGER LA PLAYLIST DEPUIS LE SERVEUR ---
            async function fetchTracks() {
                try {
                    const response = await fetch('/api/tracks');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    // Le serveur envoie maintenant une liste d'objets [{title: '...', file: '...'}, ...]
                    const tracksData = await response.json();
                    
                    // On utilise ces donn√©es directement pour cr√©er notre playlist
                    tracks = tracksData.map(track => ({
                        name: track.title, // On utilise le titre
                        src: track.file    // On utilise l'URL compl√®te et correcte
                    }));
                    
                    filteredTracks = [...tracks];
                    return true;
                } catch (error) {
                    console.error("Impossible de charger les pistes:", error);
                    trackTitleEl.textContent = "Erreur: Impossible de charger la playlist";
                    return false;
                }
            }

            // --- VISUALIZER SETUP ---
            let audioCtx, analyser, source, animationId;
            const barCount = 30;
            for (let i = 0; i < barCount; i++) {
                const bar = document.createElement('div');
                bar.classList.add('bar');
                visualizerEl.appendChild(bar);
            }
            const bars = document.querySelectorAll('.bar');

            function setupVisualizer() {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioCtx.createAnalyser();
                    source = audioCtx.createMediaElementSource(audio);
                    source.connect(analyser);
                    analyser.connect(audioCtx.destination);
                    analyser.fftSize = 128;
                }
            }

            function updateVisualizer() {
                if (!analyser || !isPlaying) return;
                animationId = requestAnimationFrame(updateVisualizer);
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                analyser.getByteFrequencyData(dataArray);
                bars.forEach((bar, index) => {
                    const value = dataArray[index * 2];
                    bar.style.height = `${Math.max(2, (value / 255) * 100)}%`;
                });
            }
            function stopVisualizer() {
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    bars.forEach(bar => bar.style.height = '2px');
                }
            }

            // --- FONCTIONS DU LECTEUR ---
            function renderPlaylist() {
                playlistEl.innerHTML = '';
                filteredTracks.forEach((track, index) => {
                    const originalIndex = tracks.indexOf(track);
                    const li = document.createElement('li');
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.classList.add('track-name');
                    nameSpan.textContent = track.name;

                    const downloadLink = document.createElement('a');
                    // Le src est maintenant l'URL compl√®te et correcte de l'API
                    downloadLink.href = track.src;
                    downloadLink.classList.add('download-btn');
                    downloadLink.innerHTML = '‚¨á';
                    downloadLink.title = `T√©l√©charger ${track.name}`;
                    downloadLink.target = '_blank';
                    // On sugg√®re un nom de fichier pour le t√©l√©chargement
                    downloadLink.setAttribute('download', track.name + '.mp3');

                    li.appendChild(nameSpan);
                    li.appendChild(downloadLink);
                    li.dataset.originalIndex = originalIndex;

                    if (originalIndex === currentTrackIndex) {
                        li.classList.add('active');
                    }
                    li.addEventListener('click', (e) => {
                        if (e.target === downloadLink) return;
                        currentTrackIndex = originalIndex;
                        loadTrack(currentTrackIndex);
                        play();
                    });
                    playlistEl.appendChild(li);
                });
                updateTrackCounter();
            }

            function loadTrack(index) {
                if (index < 0 || index >= tracks.length) return;
                currentTrackIndex = index;
                audio.src = tracks[currentTrackIndex].src;
                trackTitleEl.textContent = tracks[currentTrackIndex].name;
                updateActivePlaylistItem();
                audio.load();
                saveState();
            }

            function play() { if (!audioCtx) setupVisualizer(); audio.play(); isPlaying = true; playPauseBtn.textContent = '‚è∏'; updateVisualizer(); }
            function pause() { audio.pause(); isPlaying = false; playPauseBtn.textContent = '‚ñ∂'; stopVisualizer(); }
            function togglePlayPause() { isPlaying ? pause() : play(); }

            function nextTrack() {
                if (isShuffled) { let randomIndex; do { randomIndex = Math.floor(Math.random() * tracks.length); } while (randomIndex === currentTrackIndex && tracks.length > 1); currentTrackIndex = randomIndex; }
                else { currentTrackIndex = (currentTrackIndex + 1) % tracks.length; }
                loadTrack(currentTrackIndex); if (isPlaying) play();
            }
            function prevTrack() {
                if (isShuffled) { let randomIndex; do { randomIndex = Math.floor(Math.random() * tracks.length); } while (randomIndex === currentTrackIndex && tracks.length > 1); currentTrackIndex = randomIndex; }
                else { currentTrackIndex = (currentTrackIndex - 1 + tracks.length) % tracks.length; }
                loadTrack(currentTrackIndex); if (isPlaying) play();
            }
            
            function updateActivePlaylistItem() {
                const items = playlistEl.querySelectorAll('li');
                items.forEach(item => {
                    const originalIndex = parseInt(item.dataset.originalIndex, 10);
                    if (originalIndex === currentTrackIndex) {
                        item.classList.add('active');
                        item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    } else {
                        item.classList.remove('active');
                    }
                });
            }
            function updateTrackCounter() {
                const activeItem = playlistEl.querySelector('li.active');
                const visibleIndex = activeItem ? Array.from(playlistEl.children).indexOf(activeItem) + 1 : 0;
                trackCounterEl.textContent = `${visibleIndex > 0 ? visibleIndex : 0} / ${filteredTracks.length}`;
            }
            function formatTime(seconds) {
                if (isNaN(seconds)) return "0:00";
                const minutes = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
            }
            function saveState() { localStorage.setItem('playerState', JSON.stringify({ index: currentTrackIndex, time: audio.currentTime, volume: audio.volume, isShuffled, repeatMode })); }
            function loadState() {
                const savedState = JSON.parse(localStorage.getItem('playerState'));
                if (savedState && tracks.length > 0) {
                    currentTrackIndex = savedState.index || 0;
                    audio.volume = savedState.volume || 0.7;
                    volumeSlider.value = audio.volume;
                    isShuffled = savedState.isShuffled || false;
                    repeatMode = savedState.repeatMode || 'off';
                    updateShuffleRepeatButtons();
                    loadTrack(currentTrackIndex);
                    audio.currentTime = savedState.time || 0;
                }
            }
            function updateShuffleRepeatButtons() {
                shuffleBtn.classList.toggle('active', isShuffled);
                repeatBtn.classList.toggle('active', repeatMode !== 'off');
                repeatBtn.textContent = repeatMode === 'one' ? 'üîÇ' : 'üîÅ';
            }

            // --- √âCOUTEURS D'√âV√âNEMENTS ---
            playPauseBtn.addEventListener('click', togglePlayPause);
            nextBtn.addEventListener('click', nextTrack);
            prevBtn.addEventListener('click', prevTrack);
            shuffleBtn.addEventListener('click', () => { isShuffled = !isShuffled; updateShuffleRepeatButtons(); saveState(); });
            repeatBtn.addEventListener('click', () => { if (repeatMode === 'off') repeatMode = 'all'; else if (repeatMode === 'all') repeatMode = 'one'; else repeatMode = 'off'; updateShuffleRepeatButtons(); saveState(); });
            audio.addEventListener('timeupdate', () => { const progressPercent = (audio.currentTime / audio.duration) * 100; progressBar.style.width = `${progressPercent}%`; currentTimeEl.textContent = formatTime(audio.currentTime); if (Math.floor(audio.currentTime) % 5 === 0) { saveState(); } });
            audio.addEventListener('loadedmetadata', () => { durationEl.textContent = formatTime(audio.duration); });
            audio.addEventListener('ended', () => { if (repeatMode === 'one') { audio.currentTime = 0; play(); } else if (repeatMode === 'all' || isShuffled) { nextTrack(); } else { pause(); } });
            progressContainer.addEventListener('click', (e) => { const clickX = e.offsetX; const width = progressContainer.offsetWidth; const newTime = (clickX / width) * audio.duration; audio.currentTime = newTime; });
            volumeSlider.addEventListener('input', (e) => { audio.volume = e.target.value; saveState(); });
            searchBar.addEventListener('input', (e) => { const query = e.target.value.toLowerCase(); filteredTracks = query ? tracks.filter(track => track.name.toLowerCase().includes(query)) : [...tracks]; renderPlaylist(); });
            document.addEventListener('keydown', (e) => { if (e.target.tagName === 'INPUT') return; switch (e.code) { case 'Space': e.preventDefault(); togglePlayPause(); break; case 'ArrowLeft': prevTrack(); break; case 'ArrowRight': nextTrack(); break; } });

            // --- INITIALISATION ---
            const tracksLoaded = await fetchTracks();
            if (tracksLoaded) {
                renderPlaylist();
                loadState();
            }
        });
    </script>
</body>
</html>